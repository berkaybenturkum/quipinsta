<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuipInsta - Instagram Gönderi Bölücü | Grid Splitter Tool</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Instagram fotoğraflarınızı 3, 6 veya 9 parçaya ücretsiz bölün. Profesyonel grid bölme aracı, Python ile yüksek kalite, crop özelliği. Split Instagram posts into 3, 6, or 9 pieces free.">
    <meta name="keywords" content="instagram grid, instagram bölme, fotoğraf bölücü, grid splitter, instagram post splitter, carousel maker, instagram grid maker, ücretsiz, free, crop tool, python image processing, PIL, Pillow">
    <meta name="author" content="QuipInsta">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Turkish, English">
    <link rel="canonical" href="https://quipinsta.com/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://quipinsta.com/">
    <meta property="og:title" content="QuipInsta - Instagram Gönderi Bölücü | Grid Splitter">
    <meta property="og:description" content="Instagram fotoğraflarınızı 3, 6 veya 9 parçaya ücretsiz bölün. Profesyonel crop ve grid bölme aracı.">
    <meta property="og:image" content="https://quipinsta.com/static/og-image.jpg">
    <meta property="og:locale" content="tr_TR">
    <meta property="og:locale:alternate" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://quipinsta.com/">
    <meta name="twitter:title" content="QuipInsta - Instagram Grid Splitter">
    <meta name="twitter:description" content="Split Instagram photos into 3, 6, or 9 pieces. Free professional grid maker with crop tool.">
    <meta name="twitter:image" content="https://quipinsta.com/static/twitter-card.jpg">
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .grid-btn-active {
            background-color: #4f46e5 !important;
            color: white !important;
            border-color: #4f46e5 !important;
        }
        .hero-gradient {
            background-color: #f9fafb;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 2rem 2rem;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .crop-modal.active {
            display: flex;
        }
        .crop-container {
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .crop-container {
                width: 95%;
                padding: 15px;
                max-height: 95vh;
            }
        }
        .crop-image-container {
            flex: 1;
            max-height: 60vh;
            overflow: hidden;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .crop-image-container {
                max-height: 40vh;
                margin: 10px 0;
            }
        }
        #cropImage {
            max-width: 100%;
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <!-- ===== HEADER ===== -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-50 border-b border-gray-200">
        <div class="container mx-auto px-4 flex justify-between items-center h-20">
            <a href="#" class="text-2xl font-bold text-gray-900 tracking-tight">QuipInsta</a>
            <nav class="flex items-center gap-4">
                <a href="/contact" class="text-gray-600 font-medium hover:text-indigo-600 transition-colors" data-i18n="contact">İletişim</a>
                <div class="flex gap-2">
                    <button class="lang-btn px-3 py-1 rounded-lg border-2 border-gray-300 hover:border-indigo-500 transition ring-2 ring-indigo-500 text-sm font-semibold" data-lang="tr" onclick="setLanguage('tr')" title="Türkçe">
                        TR
                    </button>
                    <button class="lang-btn px-3 py-1 rounded-lg border-2 border-gray-300 hover:border-indigo-500 transition text-sm font-semibold" data-lang="en" onclick="setLanguage('en')" title="English">
                        ENG
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Ana İçerik -->
    <div class="flex-grow">
        <!-- ===== 1. BAŞLIK VE TANITIM ALANI ===== -->
        <section class="hero-gradient">
            <div class="container mx-auto px-4 pt-16 pb-12 text-center">
                <h1 class="text-4xl md:text-5xl font-extrabold tracking-tighter text-gray-900">
                    <span data-i18n="heroTitle">Instagram Gönderinizi</span> <span class="bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent" data-i18n="heroHighlight">3, 6 veya 9</span> <span data-i18n="heroTitleEnd">Parçaya Bölün</span>
                </h1>
                <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto" data-i18n="heroSubtitle">
                    Görsel yükleyin, grid yapısını seçin, parçaları tek tek indirin. Python ile yüksek kaliteli işleme.
                </p>
            </div>
        </section>

        <div class="container mx-auto px-4 pb-16 md:pb-24">
            <main>
                <!-- ===== ADIM 1 VE 2: E-POSTA GİRİŞİ VE GÖRSEL YÜKLEME ===== -->
                <section class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl shadow-blue-500/10 border border-gray-200 -mt-10 relative z-10">
                    
                    <!-- Adım 1: E-posta -->
                    <div id="step1Section">
                        <div class="flex items-center gap-3">
                            <div class="bg-indigo-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                            <h3 class="text-xl font-semibold text-gray-800" data-i18n="step1Title">E-posta Adresinizi Girin</h3>
                        </div>
                        <p class="text-gray-500 mt-2 text-sm ml-11" data-i18n="step1Subtitle">Cookie ile bir sonraki ziyaretinizde otomatik giriş yapılacak.</p>
                        <form id="emailForm" class="mt-4 flex flex-col sm:flex-row gap-3 ml-11">
                            <input id="emailInput" type="email" placeholder="E-posta adresiniz (zorunlu)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" data-i18n="emailPlaceholder" required>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-md hover:shadow-lg shrink-0" data-i18n="continueBtn">Devam Et</button>
                        </form>
                    </div>

                    <div class="border-t my-8"></div>

                    <!-- Adım 2: Görsel Yükleme ve Grid Seçimi -->
                    <div id="step2Section" class="opacity-40 cursor-not-allowed">
                         <div class="flex items-center gap-3">
                            <div class="bg-gray-300 text-gray-600 w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                            <h3 class="text-xl font-semibold text-gray-500" data-i18n="step2Title">Fotoğraf Yükle & Grid Seç</h3>
                        </div>
                        
                        <div class="ml-11 mt-4 pointer-events-none">
                            <input type="file" id="fileInput" accept="image/*" class="hidden">
                            <div id="dropZone" class="flex justify-center w-full h-48 px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400 transition-colors">
                                <div class="space-y-2 text-center my-auto">
                                    <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i>
                                    <p class="text-sm text-gray-600" data-i18n="uploadText">Fotoğraf Yükle veya sürükleyip bırak</p>
                                    <p class="text-xs text-gray-500" data-i18n="uploadLimit">PNG, JPG, GIF (maksimum 50MB)</p>
                                    <p class="text-xs text-gray-400 mt-1" data-i18n="recommendedSize">Önerilen boyut: 3240×1350px (3 parça için)</p>
                                </div>
                            </div>
                            
                            <div class="mt-6">
                                <p class="text-center font-semibold text-gray-700 mb-4" data-i18n="gridOptions">Grid Bölme Seçenekleri</p>
                                <div class="grid grid-cols-3 gap-4">
                                    <button class="grid-btn grid-btn-active w-full py-3 px-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition-colors" data-grid="3" data-i18n="pieces3">3 Parça</button>
                                    <button class="grid-btn w-full py-3 px-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition-colors" data-grid="6" data-i18n="pieces6">6 Parça</button>
                                    <button class="grid-btn w-full py-3 px-4 border border-gray-300 rounded-lg font-medium hover:bg-gray-100 transition-colors" data-grid="9" data-i18n="pieces9">9 Parça</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading spinner -->
                    <div id="loadingSection" class="hidden mt-8 text-center">
                        <div class="spinner mx-auto"></div>
                        <p class="mt-4 text-gray-600" data-i18n="processing">Görsel işleniyor...</p>
                    </div>
                </section>

                <!-- ===== YENİ 'NEDEN BİZ?' BÖLÜMÜ ===== -->
                <section class="max-w-4xl mx-auto mt-20">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                        <div class="bg-white p-6 rounded-lg border border-gray-200">
                            <i data-lucide="zap" class="w-10 h-10 text-indigo-500 mx-auto mb-4"></i>
                            <h3 class="font-semibold text-lg" data-i18n="feature1Title">Python Güçlü İşleme</h3>
                            <p class="text-gray-600 text-sm mt-1" data-i18n="feature1Desc">PIL/Pillow kütüphanesi ile profesyonel kalitede görsel işleme.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-gray-200">
                            <i data-lucide="award" class="w-10 h-10 text-indigo-500 mx-auto mb-4"></i>
                            <h3 class="font-semibold text-lg" data-i18n="feature2Title">Oran Korumalı</h3>
                            <p class="text-gray-600 text-sm mt-1" data-i18n="feature2Desc">Her parça tam 1080x1350px, Instagram 4:5 oranına uygun.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg border border-gray-200">
                            <i data-lucide="lock" class="w-10 h-10 text-indigo-500 mx-auto mb-4"></i>
                            <h3 class="font-semibold text-lg" data-i18n="feature3Title">Cookie Sistemi</h3>
                            <p class="text-gray-600 text-sm mt-1" data-i18n="feature3Desc">E-postanız cookie'de saklanır, bir sonraki ziyarette otomatik giriş.</p>
                        </div>
                    </div>
                </section>

                <!-- ===== 3. ÖNİZLEME VE İNDİRME ALANI ===== -->
                <section id="previewSection" class="max-w-4xl mx-auto mt-20 hidden">
                     <h2 class="text-3xl font-bold text-center mb-8" data-i18n="previewTitle">Bölünmüş Görseller</h2>
                    <div id="previewGrid" class="grid grid-cols-3 gap-4">
                        <!-- Görseller Python backend tarafından oluşturulacak -->
                    </div>
                </section>
            </main>
        </div>
    </div>


    <!-- ===== CROP MODAL ===== -->
    <div id="cropModal" class="crop-modal">
        <div class="crop-container">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-900">Görseli Ayarla</h3>
                <button id="closeCropModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="crop-image-container">
                <img id="cropImage" src="" alt="Crop">
            </div>
            
            <div class="space-y-3 mt-4">
                <!-- Crop Oran Modu -->
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <label class="text-sm font-medium text-gray-700">Crop Modu:</label>
                    <div class="flex gap-2">
                        <button id="cropModeFree" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition text-sm font-medium">Serbest Oran</button>
                        <button id="cropModeFixed" class="px-4 py-2 bg-indigo-600 text-white rounded-lg transition text-sm font-medium">Sabit Oran</button>
                    </div>
                </div>
                
                <!-- Arka Plan Rengi Seçimi -->
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <label class="text-sm font-medium text-gray-700">Boş Alan Rengi:</label>
                    <div class="flex gap-2 items-center">
                        <input type="color" id="bgColorPicker" value="#F5F5F5" class="w-12 h-10 rounded cursor-pointer border-2 border-gray-300">
                        <span class="text-xs text-gray-500">(Instagram beyaz: #F5F5F5)</span>
                    </div>
                    <button id="applyColorChange" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition text-sm font-medium ml-2">Rengi Uygula</button>
                </div>
                
                <!-- Parça Önizleme -->
                <div id="cropPreviewSection" class="hidden p-3 bg-gray-50 rounded-lg">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Parça Önizleme</h4>
                    <div id="cropPreviewGrid" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                        <!-- Parçalar burada gösterilecek -->
                    </div>
                </div>
                
                <!-- Kontrol Butonları -->
                <div class="flex flex-wrap gap-3 justify-center">
                    <button id="zoomIn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="Yakınlaştır">
                        <i data-lucide="zoom-in" class="w-5 h-5"></i>
                    </button>
                    <button id="zoomOut" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="Uzaklaştır">
                        <i data-lucide="zoom-out" class="w-5 h-5"></i>
                    </button>
                    <button id="resetCrop" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition" title="Sıfırla">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                    <button id="generatePreview" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition text-sm font-medium">
                        <i data-lucide="eye" class="w-5 h-5 inline-block -mt-1 mr-1"></i> Önizle
                    </button>
                    <button id="cancelCrop" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition font-medium">İptal</button>
                    <button id="applyCrop" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition font-medium">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <footer class="bg-gray-900 text-gray-400">
        <div class="container mx-auto px-4 py-8 text-center text-sm">
         © 2025 QuipInsta | <a href="#" class="hover:underline hover:text-white transition-colors" data-i18n="privacy">Gizlilik</a> | <a href="/contact" class="hover:underline hover:text-white transition-colors" data-i18n="contactFooter">İletişim</a>
        </div>
    </footer>
    
    <!-- Schema.org Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "QuipInsta",
        "alternateName": "Instagram Grid Splitter",
        "url": "https://quipinsta.com",
        "description": "Instagram fotoğraflarınızı 3, 6 veya 9 parçaya ücretsiz bölün. Profesyonel grid bölme aracı, Python ile yüksek kalite.",
        "applicationCategory": "PhotographyApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "Instagram Grid Splitter",
            "3, 6, 9 Parça Bölme",
            "Crop Tool",
            "Python Image Processing",
            "Ücretsiz Kullanım",
            "Çoklu Dil Desteği"
        ],
        "inLanguage": ["tr-TR", "en-US"],
        "screenshot": "https://quipinsta.com/static/screenshot.jpg"
    }
    </script>
    
    <!-- Dil çevirileri -->
    <script src="{{ url_for('static', filename='translations.js') }}"></script>
    
    <script>
        // Lucide ikonlarını sayfada etkinleştir
        lucide.createIcons();
    </script>
    
    <!-- Backend API ile çalışan uygulama -->
    <script>
        class ImageSplitterBackend {
            constructor() {
                this.emailSubmitted = false;
                this.currentGrid = 3;
                this.splitImages = [];
                this.currentFile = null;
                this.cropper = null;
                this.originalFile = null;
                this.init();
            }

            async init() {
                // Cookie kontrolü
                await this.checkCookie();
                
                // E-posta formu
                const emailForm = document.getElementById('emailForm');
                if (emailForm) {
                    emailForm.addEventListener('submit', (e) => this.handleEmailSubmit(e));
                }

                // Grid butonları
                const gridButtons = document.querySelectorAll('.grid-btn');
                gridButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleGridSelect(e));
                });

                // Dosya yükleme
                const fileInput = document.getElementById('fileInput');
                const dropZone = document.getElementById('dropZone');
                
                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                
                if (dropZone) {
                    dropZone.addEventListener('click', () => fileInput?.click());
                    dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                    dropZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    dropZone.addEventListener('drop', (e) => this.handleDrop(e));
                }

                // Crop modal butonları
                document.getElementById('closeCropModal').addEventListener('click', () => this.closeCropModal());
                document.getElementById('cancelCrop').addEventListener('click', () => this.closeCropModal());
                document.getElementById('applyCrop').addEventListener('click', () => this.applyCrop());
                document.getElementById('zoomIn').addEventListener('click', () => this.cropper?.zoom(0.1));
                document.getElementById('zoomOut').addEventListener('click', () => this.cropper?.zoom(-0.1));
                document.getElementById('resetCrop').addEventListener('click', () => this.cropper?.reset());
                
                // Crop mod butonları
                document.getElementById('cropModeFree').addEventListener('click', () => this.toggleCropMode(false));
                document.getElementById('cropModeFixed').addEventListener('click', () => this.toggleCropMode(true));
                
                // Önizle butonu
                document.getElementById('generatePreview').addEventListener('click', () => this.generatePreview());
                
                // Renk değiştir butonu
                document.getElementById('applyColorChange').addEventListener('click', () => this.applyColorChange());
            }

            toggleCropMode(isFixed) {
                if (!this.cropper) return;
                
                const freeBtn = document.getElementById('cropModeFree');
                const fixedBtn = document.getElementById('cropModeFixed');
                
                if (isFixed) {
                    // Sabit oran modu
                    let aspectRatio;
                    if (this.currentGrid === 3) {
                        aspectRatio = 3240 / 1350;
                    } else if (this.currentGrid === 6) {
                        aspectRatio = 3240 / 2700;
                    } else {
                        aspectRatio = 3240 / 4050;
                    }
                    this.cropper.setAspectRatio(aspectRatio);
                    
                    fixedBtn.classList.remove('bg-gray-200');
                    fixedBtn.classList.add('bg-indigo-600', 'text-white');
                    freeBtn.classList.remove('bg-indigo-600', 'text-white');
                    freeBtn.classList.add('bg-gray-200');
                } else {
                    // Serbest oran modu
                    this.cropper.setAspectRatio(NaN);
                    
                    freeBtn.classList.remove('bg-gray-200');
                    freeBtn.classList.add('bg-indigo-600', 'text-white');
                    fixedBtn.classList.remove('bg-indigo-600', 'text-white');
                    fixedBtn.classList.add('bg-gray-200');
                }
            }

            generatePreview() {
                if (!this.cropper) return;
                
                const bgColor = document.getElementById('bgColorPicker').value;
                const previewSection = document.getElementById('cropPreviewSection');
                const previewGrid = document.getElementById('cropPreviewGrid');
                
                // Önizleme bölümünü göster
                previewSection.classList.remove('hidden');
                previewGrid.innerHTML = '<div class="col-span-3 text-center text-sm text-gray-500">Önizleme oluşturuluyor...</div>';
                
                // Grid yapısını belirle
                let rows, cols;
                if (this.currentGrid === 3) {
                    rows = 1;
                    cols = 3;
                } else if (this.currentGrid === 6) {
                    rows = 2;
                    cols = 3;
                } else {
                    rows = 3;
                    cols = 3;
                }
                
                const targetWidth = 1080;
                const targetHeight = 1350;
                
                // Crop edilmiş görseli al
                const croppedCanvas = this.cropper.getCroppedCanvas({
                    width: targetWidth * cols,
                    height: targetHeight * rows,
                    imageSmoothingQuality: 'high',
                    fillColor: bgColor,
                });
                
                // Parçalara böl
                previewGrid.innerHTML = '';
                
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const canvas = document.createElement('canvas');
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        const ctx = canvas.getContext('2d');
                        
                        // Parçayı çiz
                        ctx.drawImage(
                            croppedCanvas,
                            col * targetWidth, row * targetHeight,
                            targetWidth, targetHeight,
                            0, 0,
                            targetWidth, targetHeight
                        );
                        
                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/jpeg', 0.8);
                        img.className = 'w-full h-auto rounded border border-gray-300';
                        
                        previewGrid.appendChild(img);
                    }
                }
                
                // İkonları güncelle
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }

            applyColorChange() {
                // Önizlemeyi yeniden oluştur
                this.generatePreview();
                this.showNotification('Renk güncellendi!', 'success');
            }

            async checkCookie() {
                try {
                    const response = await fetch('/get_cookie_email');
                    const data = await response.json();
                    
                    if (data.has_cookie && data.email) {
                        document.getElementById('emailInput').value = data.email;
                        this.showNotification('Hoş geldiniz! E-postanız cookie\'den yüklendi.', 'success');
                        // Otomatik olarak adım 2'yi aktif et
                        setTimeout(() => {
                            this.emailSubmitted = true;
                            this.enableStep2();
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Cookie kontrolü hatası:', error);
                }
            }

            async handleEmailSubmit(e) {
                e.preventDefault();
                const emailInput = document.getElementById('emailInput');
                const email = emailInput.value.trim();

                try {
                    const response = await fetch('/check_email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.emailSubmitted = true;
                        this.showNotification(data.is_new ? 'E-posta kaydedildi!' : 'Tekrar hoş geldiniz!', 'success');
                        this.enableStep2();
                    } else {
                        this.showNotification(data.error || 'Bir hata oluştu', 'error');
                    }
                } catch (error) {
                    this.showNotification('Sunucu hatası: ' + error.message, 'error');
                }
            }

            enableStep2() {
                const step2Section = document.getElementById('step2Section');
                if (step2Section) {
                    step2Section.classList.remove('opacity-40', 'cursor-not-allowed');
                    step2Section.querySelector('.ml-11').classList.remove('pointer-events-none');
                    
                    const step2Badge = step2Section.querySelector('.bg-gray-300');
                    if (step2Badge) {
                        step2Badge.classList.remove('bg-gray-300', 'text-gray-600');
                        step2Badge.classList.add('bg-indigo-600', 'text-white');
                    }
                    
                    const step2Title = step2Section.querySelector('.text-gray-500');
                    if (step2Title) {
                        step2Title.classList.remove('text-gray-500');
                        step2Title.classList.add('text-gray-800');
                    }
                }
            }

            handleGridSelect(e) {
                if (!this.emailSubmitted) {
                    this.showNotification('Önce e-posta adresinizi girin', 'error');
                    return;
                }

                const button = e.target.closest('.grid-btn');
                const newGrid = parseInt(button.dataset.grid);
                
                // Grid değişmişse
                if (newGrid !== this.currentGrid) {
                    this.currentGrid = newGrid;

                    document.querySelectorAll('.grid-btn').forEach(btn => {
                        btn.classList.remove('grid-btn-active');
                    });
                    button.classList.add('grid-btn-active');
                    
                    // Eğer daha önce görsel yüklendiyse, yeni grid ile tekrar böl
                    if (this.currentFile) {
                        this.showNotification(`${this.currentGrid} parçaya yeniden bölünüyor...`, 'info');
                        this.processFile(this.currentFile);
                    }
                }
            }

            handleFileSelect(e) {
                if (!this.emailSubmitted) {
                    this.showNotification('Önce e-posta adresinizi girin', 'error');
                    return;
                }

                const file = e.target.files[0];
                this.openCropModal(file);
            }

            handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('border-indigo-500', 'bg-indigo-50');
            }

            handleDragLeave(e) {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('border-indigo-500', 'bg-indigo-50');
            }

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (!this.emailSubmitted) {
                    this.showNotification('Önce e-posta adresinizi girin', 'error');
                    return;
                }

                e.currentTarget.classList.remove('border-indigo-500', 'bg-indigo-50');
                
                const file = e.dataTransfer.files[0];
                this.openCropModal(file);
            }

            openCropModal(file) {
                if (!file || !file.type.match('image.*')) {
                    this.showNotification('Lütfen geçerli bir görsel dosyası seçin', 'error');
                    return;
                }

                if (file.size > 50 * 1024 * 1024) {
                    this.showNotification('Dosya boyutu 50MB\'dan küçük olmalıdır', 'error');
                    return;
                }

                this.originalFile = file;
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const cropImage = document.getElementById('cropImage');
                    cropImage.src = e.target.result;
                    
                    // Modal'ı göster
                    document.getElementById('cropModal').classList.add('active');
                    
                    // Cropper'ı başlat
                    if (this.cropper) {
                        this.cropper.destroy();
                    }
                    
                    // Grid boyutuna göre aspect ratio
                    let aspectRatio;
                    if (this.currentGrid === 3) {
                        aspectRatio = 3240 / 1350; // 1x3
                    } else if (this.currentGrid === 6) {
                        aspectRatio = 3240 / 2700; // 2x3
                    } else {
                        aspectRatio = 3240 / 4050; // 3x3
                    }
                    
                    this.cropper = new Cropper(cropImage, {
                        aspectRatio: aspectRatio,
                        viewMode: 0,  // Görsel container'dan küçük olabilir
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        background: false,
                        modal: true,
                        scalable: true,
                        zoomable: true,
                        zoomOnWheel: false,
                        minContainerWidth: 200,
                        minContainerHeight: 200,
                    });
                    
                    // İkonları güncelle
                    if (window.lucide) {
                        window.lucide.createIcons();
                    }
                };
                
                reader.readAsDataURL(file);
            }

            closeCropModal() {
                document.getElementById('cropModal').classList.remove('active');
                if (this.cropper) {
                    this.cropper.destroy();
                    this.cropper = null;
                }
                
                // Önizlemeyi temizle
                document.getElementById('cropPreviewSection').classList.add('hidden');
                document.getElementById('cropPreviewGrid').innerHTML = '';
                
                // File input'u resetle (aynı dosya tekrar seçilebilsin)
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.value = '';
                }
            }

            applyCrop() {
                if (!this.cropper) return;
                
                // Seçilen arka plan rengini al
                const bgColor = document.getElementById('bgColorPicker').value;
                
                // Crop edilmiş görseli al
                this.cropper.getCroppedCanvas({
                    width: this.currentGrid === 3 ? 3240 : this.currentGrid === 6 ? 3240 : 3240,
                    height: this.currentGrid === 3 ? 1350 : this.currentGrid === 6 ? 2700 : 4050,
                    imageSmoothingQuality: 'high',
                    fillColor: bgColor,  // Arka plan rengi
                }).toBlob((blob) => {
                    // Blob'u File'a çevir
                    const croppedFile = new File([blob], this.originalFile.name, {
                        type: 'image/jpeg',
                        lastModified: Date.now()
                    });
                    
                    // Seçilen rengi sakla
                    this.currentBgColor = bgColor;
                    
                    // Modal'ı kapat
                    this.closeCropModal();
                    
                    // İşleme gönder
                    this.processFile(croppedFile);
                }, 'image/jpeg', 0.95);
            }

            async processFile(file) {
                if (!file) return;

                if (!file.type.match('image.*')) {
                    this.showNotification('Lütfen geçerli bir görsel dosyası seçin', 'error');
                    return;
                }

                if (file.size > 50 * 1024 * 1024) {
                    this.showNotification('Dosya boyutu 50MB\'dan küçük olmalıdır', 'error');
                    return;
                }

                // Dosyayı sakla (grid değiştiğinde tekrar kullanmak için)
                this.currentFile = file;

                // Loading göster
                document.getElementById('loadingSection').classList.remove('hidden');
                document.getElementById('previewSection').classList.add('hidden');

                const formData = new FormData();
                formData.append('image', file);
                formData.append('grid', this.currentGrid);
                
                // Arka plan rengini gönder (varsa)
                if (this.currentBgColor) {
                    formData.append('bg_color', this.currentBgColor);
                }

                try {
                    const response = await fetch('/split_image', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.splitImages = data.pieces;
                        this.displaySplitImages();
                        this.showNotification('Görsel başarıyla bölündü!', 'success');
                    } else {
                        this.showNotification(data.error || 'Bir hata oluştu', 'error');
                    }
                } catch (error) {
                    this.showNotification('Sunucu hatası: ' + error.message, 'error');
                } finally {
                    document.getElementById('loadingSection').classList.add('hidden');
                }
            }

            displaySplitImages() {
                const previewSection = document.getElementById('previewSection');
                const previewGrid = document.getElementById('previewGrid');
                
                previewGrid.innerHTML = '';

                this.splitImages.forEach((imgData) => {
                    const div = document.createElement('div');
                    div.className = 'flex flex-col items-center gap-3 group';
                    div.innerHTML = `
                        <img src="${imgData.data}" class="w-full h-auto rounded-lg shadow-sm transition-transform duration-300 group-hover:scale-105" alt="Grid Parçası ${imgData.index}">
                        <button class="download-btn w-full text-center bg-indigo-500 text-white py-2.5 px-4 rounded-md hover:bg-indigo-600 transition-colors text-sm font-semibold shadow transform hover:scale-105" data-index="${imgData.index}" data-img="${imgData.data}">
                            <i data-lucide="download" class="inline-block w-4 h-4 -mt-1 mr-1.5"></i> İndir ${imgData.index}
                        </button>
                    `;
                    
                    const downloadBtn = div.querySelector('.download-btn');
                    downloadBtn.addEventListener('click', () => this.downloadImage(imgData));
                    
                    previewGrid.appendChild(div);
                });

                if (window.lucide) {
                    window.lucide.createIcons();
                }

                previewSection.classList.remove('hidden');
                previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            downloadImage(imgData) {
                const link = document.createElement('a');
                link.href = imgData.data;
                link.download = `instagram-grid-${imgData.index}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.showNotification(`Parça ${imgData.index} indiriliyor...`, 'success');
            }

            showNotification(message, type = 'info') {
                const existingNotif = document.getElementById('notification');
                if (existingNotif) {
                    existingNotif.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = `fixed top-24 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-96 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 
                    'bg-blue-500'
                } text-white font-medium`;
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 10);

                setTimeout(() => {
                    notification.style.transform = 'translateX(400px)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ImageSplitterBackend();
        });
    </script>
</body>
</html>
